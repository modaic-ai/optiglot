name: Publish SDKs

on:
    release:
        types: [published]

permissions:
    contents: read
    id-token: write # Required for OIDC

jobs:
    build-python:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              run: curl -LsSf https://astral.sh/uv/install.sh | sh

            - name: Build release distributions
              run: uv build

            - name: Upload distributions
              uses: actions/upload-artifact@v4
              with:
                  name: python-dists
                  path: dist/

    publish-pypi:
        runs-on: ubuntu-latest
        needs: build-python
        permissions:
            id-token: write
        environment:
            name: pypi
            url: https://pypi.org/project/modaic/
        steps:
            - name: Download distributions
              uses: actions/download-artifact@v4
              with:
                  name: python-dists
                  path: dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1

    publish-npm:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  registry-url: "https://registry.npmjs.org"

            - uses: oven-sh/setup-bun@v2

            - name: Set version
              run: npm version ${{ github.event.release.tag_name }} --no-git-tag-version
              working-directory: clients/typescript
            - run: bun install --frozen-lockfile
              working-directory: clients/typescript
            - run: bun run build
              working-directory: clients/typescript
            - run: bun test
              working-directory: clients/typescript
            - run: npm publish
              working-directory: clients/typescript
